<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<script>
// Recommendation weights: loaded from backend or localStorage fallback
let WEIGHTS = JSON.parse(localStorage.getItem('recommendationWeights')) || {
    language: 20,
    scale: 25,
    timeSignature: 20,
    taal: 15,
    tempo: 5,
    genre: 5,
    vocal: 5,
    mood: 5
};

async function fetchRecommendationWeights() {
    try {
        const res = await fetch(`${API_BASE_URL}/api/recommendation-weights`);
        if (res.ok) {
            const data = await res.json();
            WEIGHTS = data;
            localStorage.setItem('recommendationWeights', JSON.stringify(data));
        }
    } catch (e) { /* fallback to local */ }
}

async function saveRecommendationWeightsToBackend(weights) {
    try {
        const res = await fetch(`${API_BASE_URL}/api/recommendation-weights`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('jwtToken') || ''}`
            },
            body: JSON.stringify(weights)
        });
        if (res.ok) {
            const data = await res.json();
            localStorage.setItem('recommendationWeights', JSON.stringify(weights));
            WEIGHTS = weights;
            return { success: true, message: data.message || 'Weights updated' };
        } else {
            const err = await res.json();
            return { success: false, message: err.error || 'Failed to update weights' };
        }
    } catch (e) {
        return { success: false, message: 'Network error' };
    }
}
</script>
    <!-- Auth0 script removed: now using local JWT auth -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New & Old Songs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <link rel="stylesheet" href="styles.css">
        <script>
        // Theme toggle logic (used by sidebar button)
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }
        </script>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal" id="loginModal" style="display:none;">
        <div class="modal-content auth-modal-content">
            <span class="close-modal" id="closeLoginModal" aria-label="Close" title="Close Login Modal">×</span>
            <h2 style="text-align:center;margin-bottom:18px;">Login</h2>
            <form id="loginForm" class="auth-form">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" required autocomplete="username">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required autocomplete="current-password">
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:10px;" title="Login - Sign in with your credentials" aria-label="Login">Login</button>
                <div id="loginError" style="color:#c31010;margin-top:10px;display:none;"></div>
                <p style="text-align:center;margin-top:15px;">
                    <a href="#" id="forgotPasswordLink" style="color:#667eea;text-decoration:none;">Forgot Password?</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal" style="display:none;">
        <div class="modal-content auth-modal-content">
            <span class="close-modal" id="closeRegisterModal" aria-label="Close" title="Close Registration Modal">×</span>
            <h2 style="text-align:center;margin-bottom:18px;">Register</h2>
            <form id="registerForm" class="auth-form">
                <label for="registerFirstName">First Name</label>
                <input type="text" id="registerFirstName" required autocomplete="given-name">
                <label for="registerLastName">Last Name</label>
                <input type="text" id="registerLastName" required autocomplete="family-name">
                <label for="registerUsername">Username</label>
                <input type="text" id="registerUsername" required autocomplete="username">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" required autocomplete="email">
                <label for="registerPhone">Phone Number</label>
                <input type="tel" id="registerPhone" required autocomplete="tel">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" required autocomplete="new-password">
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:10px;" title="Register - Create new account with your details" aria-label="Register">Register</button>
                <div id="registerError" style="color:#c31010;margin-top:10px;display:none;"></div>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal" style="display:none;">
        <div class="modal-content auth-modal-content">
            <span class="close-modal" id="closeForgotPasswordModal" aria-label="Close" title="Close Password Reset Modal">×</span>
            <h2 style="text-align:center;margin-bottom:18px;">Reset Password</h2>
            <form id="forgotPasswordForm" class="auth-form">
                <label for="resetIdentifier">Email or Phone Number</label>
                <input type="text" id="resetIdentifier" required placeholder="Enter email or phone number">
                <label for="resetMethod">Send OTP via:</label>
                <select id="resetMethod" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ddd;border-radius:4px;">
                    <option value="email">Email</option>
                    <option value="sms">SMS</option>
                </select>
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:10px;" title="Send OTP - Request verification code for password reset" aria-label="Send OTP">Send OTP</button>
                <div id="forgotPasswordError" style="color:#c31010;margin-top:10px;display:none;"></div>
                <div id="forgotPasswordSuccess" style="color:#28a745;margin-top:10px;display:none;"></div>
            </form>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div class="modal" id="otpVerificationModal" style="display:none;">
        <div class="modal-content auth-modal-content">
            <span class="close-modal" id="closeOtpModal" aria-label="Close" title="Close OTP Verification Modal">×</span>
            <h2 style="text-align:center;margin-bottom:18px;">Verify OTP</h2>
            <div id="otpInstructions" style="text-align:center;margin-bottom:20px;color:#666;"></div>
            <form id="otpVerificationForm" class="auth-form">
                <label for="otpCode">Enter OTP</label>
                <input type="text" id="otpCode" required placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required autocomplete="new-password" placeholder="Enter new password (min 6 characters)">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" required autocomplete="new-password" placeholder="Confirm new password">
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:10px;" title="Reset Password - Set new password with OTP verification" aria-label="Reset Password">Reset Password</button>
                <div id="otpError" style="color:#c31010;margin-top:10px;display:none;"></div>
                <div style="text-align:center;margin-top:15px;">
                    <button type="button" id="resendOtpBtn" class="btn" style="background:none;border:1px solid #667eea;color:#667eea;padding:8px 16px;" title="Resend OTP - Request a new verification code" aria-label="Resend OTP">Resend OTP</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Loading spinner removed -->
    <div class="app-container">
        <button class="panel-toggle draggable" id="toggle-sidebar" title="Show/Hide Sidebar Panel - Contains navigation, setlists, and settings" aria-label="Toggle Sidebar Panel"><i class="fas fa-home"></i></button>
        <button class="panel-toggle draggable" id="toggle-songs" title="Show/Hide Songs List Panel - Browse and filter songs by category" aria-label="Toggle Songs Panel"><i class="fas fa-list"></i></button>
        <button class="panel-toggle draggable" id="toggle-all-panels" title="Show/Hide All Panels - Toggle both sidebar and songs panels at once" aria-label="Toggle All Panels"><i class="fas fa-eye-slash"></i></button>

        <!-- Auto-scroll controls -->
        <div class="auto-scroll-controls">
            <button class="auto-scroll-btn" id="toggleAutoScroll" title="Auto Scroll - Automatically scroll through song lyrics at set speed" aria-label="Toggle Auto Scroll"><i class="fas fa-play"></i></button>
        </div>

        <!-- Keep screen on button -->
        <!-- <button class="keep-screen-on" id="keepScreenOnBtn" title="Keep Screen On"><i class="fa fa-sign-language"></i></button> -->

        <!-- Notification -->
        <div class="notification" id="notification"></div>

        <!-- Sidebar -->
        <div class="sidebar hidden">
            <div class="sidebar-header">
                <h2>New & Old</h2>
            </div>
            <ul class="sidebar-menu">
                <button id="loginBtn" class="sidebar-btn btn-login" title="Login to access personal setlists and save favorites" aria-label="Login"><i class="fas fa-sign-in-alt"></i> Login</button>
                <button id="registerBtn" class="sidebar-btn btn-login" title="Create new account to save personal data and setlists" aria-label="Register"><i class="fas fa-user-plus"></i> Register</button>
                <div id="userGreeting" style="display:none;font-weight:bold;margin-bottom:8px;"></div>
                <button id="logoutBtn" class="sidebar-btn btn-login" style="display:none;" title="Sign out from your account" aria-label="Logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
                <button id="adminPanelBtn" class="sidebar-btn" style="display:none;" title="Admin Panel - Manage users, recommendation weights, and detect duplicates" aria-label="Admin Panel"><i class="fas fa-cogs"></i> Admin Panel</button>
                <li><a href="#" class="active" id="showAll" title="View all songs in the database - Browse New and Old categories">All Songs</a></li>
                <li>
                    <div class="setlist-selector">
                        <div class="custom-setlist-dropdown" id="customSetlistDropdown">
                            <div class="dropdown-main-area" id="dropdownMainArea">
                                <span class="dropdown-text" id="dropdownText">Select a Setlist</span>
                            </div>
                            <div class="dropdown-arrow" id="dropdownArrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <select id="setlistDropdown" style="display: none;">
                                <option value="">Select a Setlist</option>
                            </select>
                            <div class="dropdown-menu" id="dropdownMenu" style="display: none;">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </li>   
                
                <!-- Setlist Description Display -->
                <div class="setlist-description-container" id="setlistDescriptionContainer" style="display: none;">
                    <div class="setlist-description-content">
                        <div class="setlist-description-text" id="setlistDescriptionText"></div>
                    </div>
                </div>
                
                <li><a href="#" id="showFavorites" title="View your favorite songs - Heart icon to add/remove favorites">Favorites</a></li>
                <li><button id="addSongBelowFavoritesBtn" class="sidebar-btn" style="width:100%;margin-top:10px;" title="Add New Song - Create a new song entry with lyrics, key, tempo and other details" aria-label="Add New Song"><i class="fa fa-plus"></i> Add New Song</button></li>

                <!-- Global Setlists Section -->
                <li style="margin-top:15px;">
                    <div class="setlist-folder">
                        <div class="folder-header" id="globalSetlistHeader">
                            <i class="fas fa-chevron-right folder-icon" id="globalSetlistIcon"></i>
                            <i class="fas fa-globe"></i>
                            <span>Global Setlists</span>
                            <button id="addGlobalSetlistBtn" class="add-setlist-btn" style="display:none;" title="Create Global Setlist - Admin only: Create setlists visible to all users" aria-label="Add Global Setlist">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <ul class="setlist-folder-content" id="globalSetlistContent" style="display:none;">
                            <!-- Global setlists will be populated here -->
                        </ul>
                        
                        <!-- Global Setlist Description -->
                        <div class="setlist-description-container" id="globalSetlistDescriptionContainer" style="display: none;">
                            <div class="setlist-description-content">
                                <div class="setlist-description-text" id="globalSetlistDescriptionText"></div>
                            </div>
                        </div>
                    </div>
                </li>

                <!-- My Setlists Section -->
                <li>
                    <div class="setlist-folder">
                        <div class="folder-header" id="mySetlistHeader">
                            <i class="fas fa-chevron-right folder-icon" id="mySetlistIcon"></i>
                            <i class="fas fa-user"></i>
                            <span>My Setlists</span>
                            <button id="addMySetlistBtn" class="add-setlist-btn" style="display:none;" title="Create Personal Setlist - Create your own private setlist collection" aria-label="Add My Setlist">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <ul class="setlist-folder-content" id="mySetlistContent" style="display:none;">
                            <!-- My setlists will be populated here -->
                        </ul>
                        
                        <!-- My Setlist Description -->
                        <div class="setlist-description-container" id="mySetlistDescriptionContainer" style="display: none;">
                            <div class="setlist-description-content">
                                <div class="setlist-description-text" id="mySetlistDescriptionText"></div>
                            </div>
                        </div>
                    </div>
                </li>

            </ul>
            </ul>
            <div class="sidebar-footer">
                <div class="sidebar-footer">
                    <div class="song-count">
                        <div>Total Songs: <span id="totalSongs">0</span></div>
                        <div>New: <span id="NewCount">0</span></div>
                        <div>Old: <span id="OldCount">0</span></div>
                    </div>

                    <button class="theme-toggle" id="themeToggle" style="width:100%;margin-top:10px;" title="Switch Theme - Toggle between light and dark mode for better reading" aria-label="Toggle Theme">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </button>

                    <button class="sidebar-btn" id="downloadHtmlWithSongsBtn" style="display:none;">
                        <i class="fas fa-file-export"></i> Download HTML with Songs
                    </button>
                </div>
                <div class="sidebar-folder" style="display:none;">
                    <div class="folder-toggle" id="toggleSongTools">
                        <i class="fas fa-folder-open"></i> Song Tools
                        <i class="fas fa-caret-down folder-caret"></i>
                    </div>
                    <div class="folder-content" id="songToolsContent">
                        <button class="sidebar-btn" id="openAddSongModal" title="Add New Song - Open form to create a new song with complete details" aria-label="Add New Song">
                            <i class="fa fa-plus"></i> Add New Song
                        </button>
                        <button class="sidebar-btn" id="downloadSongsBtn" title="Download Songs - Export all songs and favorites as JSON file for backup" aria-label="Download Songs">
                            <i class="fas fa-download"></i> Download Songs
                        </button>
                        <button class="sidebar-btn btn-delete" id="deleteAllSongsBtn" title="Delete All Songs - DANGER: Permanently remove all songs from database" aria-label="Delete All Songs">
                            <i class="fas fa-trash-alt"></i> Delete All Songs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Songs Panel -->
        <div class="songs-section hidden">
            <div class="sticky-header">
                <div class="tabs">
                    <div class="setlist-tab active" id="NewTab" title="New Songs - Recently added songs and contemporary music" aria-label="New Songs Tab">New</div>
                    <div class="setlist-tab" id="OldTab" title="Old Songs - Classic and traditional songs" aria-label="Old Songs Tab">Old</div>
                </div>
                <div class="filters-row">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="compact-input" placeholder="Search songs..."
                               style="padding-right: 30px;" autocomplete="off">
                        <span id="clearSearch" class="clear-search-btn" style="display: none;" title="Clear Search - Remove current search query and show all songs" aria-label="Clear Search">×</span>
                        <div id="searchHistoryDropdown" class="search-history-dropdown"></div>
                    </div>
                    <div class="filter-row-1">
                        <select id="keyFilter" class="compact-select">
  <!-- Options will be populated by JS -->
                        </select>
                        <select id="genreFilter" class="compact-select">
  <!-- Options will be populated by JS -->
                        </select>
                        <select id="moodFilter" class="compact-select">
  <!-- Options will be populated by JS -->
                        </select>
                        <select id="artistFilter" class="compact-select">
  <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="filter-row-2" style="margin-top:6px;">
                        <select id="sortFilter" class="compact-select">
                            <option value="recent">Recently Added</option>
                            <option value="az">A-Z</option>
                            <option value="za">Z-A</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                </div>

                <div class="search-results" id="searchResults">
                    <div class="search-results-header">Search Results</div>
                    <div id="searchResultsContent" class="scrollable-results"></div>
                </div>
            </div>
            <div class="tab-content active" id="NewContent"></div>
            <div class="tab-content" id="OldContent"></div>
            <div class="setlist" id="setlistSection" style="display: none;">
                <div class="setlist-header">
                    <h3 id="setlistViewHeader">Setlist View</h3>
                    <div class="setlist-header-actions" id="setlistSectionActions" style="display: none;">
                        <button id="editSetlistSectionBtn" class="btn btn-secondary setlist-action-btn" title="Edit Setlist - Modify setlist name, description and song selection" aria-label="Edit Setlist">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button id="deleteSetlistSectionBtn" class="btn btn-danger setlist-action-btn" title="Delete Setlist - Permanently remove this setlist" aria-label="Delete Setlist">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button id="resequenceSetlistSectionBtn" class="btn btn-primary setlist-action-btn" title="Resequence Songs - Drag and drop to reorder songs in setlist" aria-label="Resequence Setlist">
                            <i class="fas fa-random"></i>
                        </button>
                        <button id="saveSetlistSequenceBtn" class="btn btn-success setlist-action-btn" style="display:none;" title="Save New Sequence - Confirm the new song order" aria-label="Save Sequence">
                            <i class="fas fa-save"></i> Save Sequence
                        </button>
                        <button id="addManualSongBtn" class="btn btn-primary setlist-action-btn" title="Add Song - Add existing song or create new manual entry for setlist" aria-label="Add Song to Setlist">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="setlist-tabs">
                    <div class="setlist-tab active" id="NewSetlistTab" title="New Songs in Setlist - View contemporary songs in this setlist" aria-label="New Setlist Songs Tab">New</div>
                    <div class="setlist-tab" id="OldSetlistTab" title="Old Songs in Setlist - View classic songs in this setlist" aria-label="Old Setlist Songs Tab">Old</div>
                </div>
                <div class="setlist-content">
                    <div id="NewSetlistSongs"></div>
                    <div id="OldSetlistSongs" style="display: none;"></div>
                </div>
            </div>
            <div class="delete-section" id="deleteSection" style="display: none;">
                <h3>Delete Songs</h3>
                <div id="deleteContent"></div>
            </div>
            <div class="favorites-section" id="favoritesSection" style="display: none;">
                <h3>Favorite Songs</h3>
                <div id="favoritesContent"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="songPreview">
            <button id="installAppBtn" style="display:none;" title="Install App - Add this web app to your home screen for offline access" aria-label="Install App">
            <i class="fas fa-download" style="margin-right:8px;"></i>
            Add to Home Screen
            </button>
            <h2>Select a song</h2>
            <div class="song-lyrics">No song is selected</div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="adminPanelModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Admin Panel">×</span>
            <h2>Admin Panel</h2>
            <div class="admin-tabs">
                <button class="admin-tab active" id="userMgmtTab" title="User Management - Manage user accounts and admin privileges" aria-label="User Management Tab">User Management</button>
                <button class="admin-tab" id="weightsTab" title="Recommendation Weights - Configure song recommendation algorithm parameters" aria-label="Recommendation Weights Tab">Recommendation Weights</button>
                <button class="admin-tab" id="duplicateDetectionTab" title="Duplicate Detection - Find and manage duplicate songs in database" aria-label="Duplicate Detection Tab">Duplicate Detection</button>
            </div>
            <div class="admin-tab-content" id="userMgmtTabContent">
                <div class="notification" id="adminNotification"></div>
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Remove Admin</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="admin-tab-content" id="weightsTabContent" style="display:none;">
                <div class="notification" id="weightsNotification"></div>
                <form id="weightsForm" style="max-width: 420px; margin: 0 auto;">
                    <table id="weightsTable" style="width:100%; border-collapse:collapse; background:#fff; margin-bottom:16px;">
                    <div id="weightsTotalBar" style="margin: 10px 0 8px 0; text-align:center; font-weight:600; font-size:1.08em;"></div>
                        <thead>
                            <tr style="background:#f6f8fa; color:#3498db; font-weight:600;">
                                <th style="padding:10px 8px; text-align:left;">Parameter</th>
                                <th style="padding:10px 8px; text-align:left;">Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:10px 8px;">Language</td>
                                   <td style="padding:10px 8px;"><input type="number" id="weightLanguage" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Scale</td>
                                   <td style="padding:10px 8px;"><input type="number" id="weightScale" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Time Signature</td>
                                   <td style="padding:10px 8px;"><input type="number" id="weightTimeSignature" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Taal</td>
                                   <td style="padding:10px 8px;"><input type="number" id="weightTaal" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Tempo</td>
                                   <td style="padding:10px 8px;"><input type="number" id="weightTempo" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Genre</td>
                                   <td style="padding:10px 8px;"><input type="number" id="weightGenre" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Vocal</td>
                                <td style="padding:10px 8px;"><input type="number" id="weightVocal" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                            <tr>
                                <td style="padding:10px 8px;">Mood</td>
                                <td style="padding:10px 8px;"><input type="number" id="weightMood" min="0" max="100" step="5" required style="width:60px;"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="submit" class="btn" style="width:100%;margin-top:8px;" title="Save Weights - Apply new recommendation algorithm parameters" aria-label="Save Weights">Save Weights</button>
                </form>
                <div style="text-align:center; color:#888; font-size:0.98em; margin-top:4px;">Total should be 100 for best results.</div>
            </div>
            <div class="admin-tab-content" id="duplicateDetectionTabContent" style="display:none;">
                <!-- Duplicate detection results will be rendered by JS -->
            </div>
        </div>
    </div>

    <div class="modal" id="addSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Add Song Modal">×</span>
            <h3>Add New Song</h3>
            <form id="newSongForm" class="add-song-form">
                <label for="songTitle">Title:</label>
                <input type="text" id="songTitle" required>
                <label for="songCategory">Category:</label>
                <select id="songCategory" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="songKey">Key:</label>
                <select id="songKey" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="songArtist">Artist Details:</label>
                <div class="multiselect-container">
                    <input type="text" id="songArtist" class="compact-input" placeholder="Search and select artists..." readonly>
                    <div class="multiselect-dropdown" id="artistDropdown">
                        <!-- Artist options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="selectedArtists"></div>
                </div>
                <label for="songMood">Mood:</label>
                <div class="multiselect-container">
                    <input type="text" id="songMood" class="compact-input" placeholder="Search and select moods..." readonly>
                    <div class="multiselect-dropdown" id="moodDropdown">
                        <!-- Mood options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="selectedMoods"></div>
                </div>
                <label for="songTempo">Tempo (BPM):</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="text" id="songTempo" placeholder="e.g., 80 BPM" >
                    <button type="button" id="tapTempoBtn" class="tap-tempo-btn" title="Tap Tempo - Click repeatedly to measure and set tempo in BPM" aria-label="Tap Tempo">Tap Tempo</button>
                </div>
                <label for="songTime">Time Signature:</label>
                <select id="songTime" >
  <!-- Options will be populated by JS -->
                </select>
                <label for="songTaal">Taal:</label>
                <select id="songTaal" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="songGenre">Genre:</label>
                <div class="multiselect-container">
                    <input type="text" id="songGenre" class="compact-input" placeholder="Search genres...">
                    <div class="multiselect-dropdown" id="genreDropdown">
                        <!-- Genre options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="selectedGenres"></div>
                </div>
                <label for="songLyrics">Lyrics:</label>
                <textarea id="songLyrics" required></textarea>
                <button type="submit" class="btn btn-primary" title="Add Song - Create new song with all details and lyrics" aria-label="Add Song">Add Song</button>
            </form>
        </div>
    </div>

    <div class="modal" id="editSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Edit Song Modal">×</span>
            <h3>Edit Song</h3>
            <form id="editSongForm" class="edit-song-form">
                <input type="hidden" id="editSongId">
                <label for="editSongTitle">Title:</label>
                <input type="text" id="editSongTitle" required>
                <label for="editSongCategory">Category:</label>
                <select id="editSongCategory" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="editSongKey">Key:</label>
                <select id="editSongKey" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="editSongArtist">Artist Details:</label>
                <div class="multiselect-container">
                    <input type="text" id="editSongArtist" class="compact-input" placeholder="Search and select artists..." readonly>
                    <div class="multiselect-dropdown" id="editArtistDropdown">
                        <!-- Artist options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="editSelectedArtists"></div>
                </div>
                <label for="editSongMood">Mood:</label>
                <div class="multiselect-container">
                    <input type="text" id="editSongMood" class="compact-input" placeholder="Search and select moods..." readonly>
                    <div class="multiselect-dropdown" id="editMoodDropdown">
                        <!-- Mood options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="editSelectedMoods"></div>
                </div>
                <label for="editSongTempo">Tempo (BPM):</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="text" id="editSongTempo" placeholder="e.g., 80 BPM">
                    <button type="button" id="editTapTempoBtn" class="tap-tempo-btn" title="Tap Tempo - Click repeatedly to measure and set tempo in BPM" aria-label="Tap Tempo">Tap Tempo</button>
                </div>
                <label for="editSongTime">Time Signature:</label>
                <select id="editSongTime" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="editSongTaal">Taal:</label>
                <select id="editSongTaal" required>
  <!-- Options will be populated by JS -->
                </select>
                <label for="editSongGenre">Genre:</label>
                <div class="multiselect-container">
                    <input type="text" id="editSongGenre" class="compact-input" placeholder="Search genres...">
                    <div class="multiselect-dropdown" id="editGenreDropdown">
                        <!-- Genre options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="editSelectedGenres"></div>
                </div>
                <label for="editSongLyrics">Lyrics:</label>
                <textarea id="editSongLyrics" required></textarea>
                <button type="submit" class="btn btn-primary" title="Save Changes - Update song with modified details" aria-label="Save Changes">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="deleteSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Delete Confirmation Modal">×</span>
            <h3>Confirm Deletion</h3>
            <form id="deleteSongForm" class="delete-song-form">
                <input type="hidden" id="deleteSongId">
                <p id="deleteSongMessage">Are you sure you want to delete "<span id="deleteSongTitle"></span>"?</p>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-cancel" id="cancelDeleteSong" title="Cancel Delete - Keep the song" aria-label="Cancel Delete Song">Cancel</button>
                    <button type="submit" class="btn btn-delete" title="Confirm Delete - Permanently remove this song" aria-label="Confirm Delete Song">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="confirmDeleteAllModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Delete All Confirmation Modal">×</span>
            <h3>Confirm Delete All Songs</h3>
            <div class="delete-song-form">
                <p>Are you sure you want to delete ALL songs? This cannot be undone.</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-cancel" id="cancelDeleteAll" title="Cancel Delete All - Keep all songs safe" aria-label="Cancel Delete All Songs">Cancel</button>
                    <button class="btn btn-delete" id="confirmDeleteAll" title="Confirm Delete All - DANGER: Permanently remove all songs" aria-label="Confirm Delete All Songs">Delete All</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('settingsModal').style.display='none'" title="Close Settings Modal" aria-label="Close Settings">×</span>
            <h3>Settings</h3>
            <form id="settingsForm">
                <div class="settings-grid">
                    <div class="settings-group" style="display: none;">
                        <label for="sidebarHeaderInput">Sidebar Header:</label>
                        <input type="text" id="sidebarHeaderInput" >
                    </div>
                    <div class="settings-group" style="display: none;">
                        <label for="setlistTextInput">Setlist Menu Text:</label>
                        <input type="text" id="setlistTextInput" >
                    </div>
                    <div class="settings-group">
                        <label for="sessionResetOption">Session Reset:</label>
                        <select id="sessionResetOption">
                            <option value="manual">Manual (default)</option>
                            <option value="onClose">Reset on window close</option>
                            <option value="onRefresh">Reset on page refresh</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label for="panelWidthInput">Panel Width (%):</label>
                        <select id="panelWidthInput">
                            <option value="10">10%</option>
                            <option value="20">20%</option>
                            <option value="30">30%</option>
                            <option value="40">40%</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label for="previewMarginInput">Preview Margin Left (px):</label>
                        <input type="number" id="previewMarginInput" min="0" max="100" value="5">
                    </div>
                    <div class="settings-group">
                        <label for="autoScrollSpeedInput">Auto Scroll Speed:</label>
                        <select id="autoScrollSpeedInput">
                            <option value="2000">Slow</option>
                            <option value="1500" selected>Medium</option>
                            <option value="1000">Fast</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" title="Save Settings - Apply new interface and behavior preferences" aria-label="Save Settings">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Global Setlist Modal -->
    <div class="modal" id="globalSetlistModal">
        <div class="modal-content setlist-modal-content">
            <span class="close-modal" aria-label="Close" title="Close Global Setlist Modal">×</span>
            <h3 id="globalSetlistModalTitle">Create Global Setlist</h3>
            <form id="globalSetlistForm" class="setlist-form">
                <input type="hidden" id="globalSetlistId">
                <label for="globalSetlistName">Setlist Name:</label>
                <input type="text" id="globalSetlistName" required placeholder="Enter setlist name">
                <label for="globalSetlistDescription">Description (optional):</label>
                <textarea id="globalSetlistDescription" placeholder="Enter setlist description"></textarea>
                
                <!-- Main Tabs for Global Setlist -->
                <div class="setlist-main-tabs">
                    <div class="setlist-main-tab active" id="globalSelectedSongsMainTab">Selected Songs</div>
                    <div class="setlist-main-tab" id="globalAddSongsMainTab">Add Songs</div>
                </div>
                
                <!-- Selected Songs Tab Content -->
                <div class="setlist-main-tab-content active" id="globalSelectedSongsContent">
                    <div class="selected-songs-summary">
                        <h4>Selected Songs: <span id="globalSelectedCount">0</span></h4>
                        
                        <!-- Tabs for Selected Old/New Songs -->
                        <div class="modal-song-tabs">
                            <div class="modal-tab active" id="globalSelectedOldTab">Old Songs (<span id="globalSelectedOldCount">0</span>)</div>
                            <div class="modal-tab" id="globalSelectedNewTab">New Songs (<span id="globalSelectedNewCount">0</span>)</div>
                        </div>
                        
                        <div class="selected-songs-container">
                            <!-- Selected Old Songs Tab Content -->
                            <div class="modal-tab-content active" id="globalSelectedOldContent">
                                <div id="globalSelectedOldSongsList" class="selected-songs-list modal-scrollable-summary"></div>
                            </div>
                            
                            <!-- Selected New Songs Tab Content -->
                            <div class="modal-tab-content" id="globalSelectedNewContent">
                                <div id="globalSelectedNewSongsList" class="selected-songs-list modal-scrollable-summary"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add Songs Tab Content -->
                <div class="setlist-main-tab-content" id="globalAddSongsContent">
                    <div class="song-selection-section">
                        <label>Select Songs:</label>
                    
                    <!-- Search and Filters -->
                    <div class="modal-filters-container">
                        <div class="song-search-container">
                            <input type="text" id="globalSetlistSongSearch" placeholder="Search songs..." class="song-search-input">
                        </div>
                        <div class="modal-filters-row">
                            <select id="globalKeyFilter" class="compact-select">
                                <option value="">Keys</option>
                            </select>
                            <select id="globalGenreFilter" class="compact-select">
                                <option value="">Genres</option>
                            </select>
                            <select id="globalMoodFilter" class="compact-select">
                                <option value="">Moods</option>
                            </select>
                            <select id="globalArtistFilter" class="compact-select">
                                <option value="">Artists</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Tabs for Old/New Songs -->
                    <div class="modal-song-tabs">
                        <div class="modal-tab active" id="globalOldSongsTab">Old Songs</div>
                        <div class="modal-tab" id="globalNewSongsTab">New Songs</div>
                    </div>
                    
                    <div class="song-selection-container">
                        <!-- Old Songs Tab Content -->
                        <div class="modal-tab-content active" id="globalOldSongsContent">
                            <div class="song-category-header">
                                <label class="select-all-label">
                                    <input type="checkbox" id="globalSelectAllOldSongs"> Select All Old Songs (<span id="globalOldSongsCount">0</span>)
                                </label>
                            </div>
                            <div id="globalOldSongSelectionList" class="song-selection-list modal-scrollable"></div>
                        </div>
                        
                        <!-- New Songs Tab Content -->
                        <div class="modal-tab-content" id="globalNewSongsContent">
                            <div class="song-category-header">
                                <label class="select-all-label">
                                    <input type="checkbox" id="globalSelectAllNewSongs"> Select All New Songs (<span id="globalNewSongsCount">0</span>)
                                </label>
                            </div>
                            <div id="globalNewSongSelectionList" class="song-selection-list modal-scrollable"></div>
                        </div>
                    </div>
                </div>
                
                <!-- End of Add Songs tab content -->
            </div>
            <!-- Submit button now outside tab content -->
            <div class="setlist-submit-container">
                <button type="submit" class="btn btn-primary" id="globalSetlistSubmit" title="Create Global Setlist - Save new setlist visible to all users" aria-label="Create Global Setlist">Create Setlist</button>
            </div>
        </form>
        </div>
    </div>

    <!-- My Setlist Modal -->
    <div class="modal" id="mySetlistModal">
        <div class="modal-content setlist-modal-content">
            <span class="close-modal" aria-label="Close" title="Close My Setlist Modal">×</span>
            <h3 id="mySetlistModalTitle">Create My Setlist</h3>
            <form id="mySetlistForm" class="setlist-form">
                <input type="hidden" id="mySetlistId">
                <label for="mySetlistName">Setlist Name:</label>
                <input type="text" id="mySetlistName" required placeholder="Enter setlist name">
                <label for="mySetlistDescription">Description (optional):</label>
                <textarea id="mySetlistDescription" placeholder="Enter setlist description"></textarea>
                
                <!-- Main Tab Navigation -->
                <div class="setlist-main-tabs">
                    <div class="setlist-main-tab active" id="selectedSongsMainTab">
                        <i class="fas fa-list"></i> Selected Songs (<span id="mySelectedCount">0</span>)
                    </div>
                    <div class="setlist-main-tab" id="addSongsMainTab">
                        <i class="fas fa-plus"></i> Add Songs
                    </div>
                </div>
                
                <!-- Selected Songs Tab Content -->
                <div class="setlist-main-tab-content active" id="selectedSongsContent">
                    <div class="selected-songs-summary">
                        <!-- Tabs for Selected Old/New Songs -->
                        <div class="modal-song-tabs">
                            <div class="modal-tab active" id="mySelectedOldTab">Old Songs (<span id="mySelectedOldCount">0</span>)</div>
                            <div class="modal-tab" id="mySelectedNewTab">New Songs (<span id="mySelectedNewCount">0</span>)</div>
                        </div>
                        
                        <div class="selected-songs-container">
                            <!-- Selected Old Songs Tab Content -->
                            <div class="modal-tab-content active" id="mySelectedOldContent">
                                <div id="mySelectedOldSongsList" class="selected-songs-list modal-scrollable-summary"></div>
                            </div>
                            
                            <!-- Selected New Songs Tab Content -->
                            <div class="modal-tab-content" id="mySelectedNewContent">
                                <div id="mySelectedNewSongsList" class="selected-songs-list modal-scrollable-summary"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add Songs Tab Content -->
                <div class="setlist-main-tab-content" id="addSongsContent">
                    <div class="song-selection-section">
                        <!-- Search and Filters -->
                        <div class="modal-filters-container">
                            <div class="song-search-container">
                                <input type="text" id="mySetlistSongSearch" placeholder="Search songs..." class="song-search-input">
                            </div>
                            <div class="modal-filters-row">
                                <select id="myKeyFilter" class="compact-select">
                                    <option value="">Keys</option>
                                </select>
                                <select id="myGenreFilter" class="compact-select">
                                    <option value="">Genres</option>
                                </select>
                                <select id="myMoodFilter" class="compact-select">
                                    <option value="">Moods</option>
                                </select>
                                <select id="myArtistFilter" class="compact-select">
                                    <option value="">Artists</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Tabs for Old/New Songs -->
                        <div class="modal-song-tabs">
                            <div class="modal-tab active" id="myOldSongsTab">Old Songs</div>
                            <div class="modal-tab" id="myNewSongsTab">New Songs</div>
                        </div>
                        
                        <div class="song-selection-container">
                            <!-- Old Songs Tab Content -->
                            <div class="modal-tab-content active" id="myOldSongsContent">
                                <div class="song-category-header">
                                    <label class="select-all-label">
                                        <input type="checkbox" id="mySelectAllOldSongs"> Select All Old Songs (<span id="myOldSongsCount">0</span>)
                                    </label>
                                </div>
                                <div id="myOldSongSelectionList" class="song-selection-list modal-scrollable"></div>
                            </div>
                            
                            <!-- New Songs Tab Content -->
                            <div class="modal-tab-content" id="myNewSongsContent">
                                <div class="song-category-header">
                                    <label class="select-all-label">
                                        <input type="checkbox" id="mySelectAllNewSongs"> Select All New Songs (<span id="myNewSongsCount">0</span>)
                                    </label>
                                </div>
                                <div id="myNewSongSelectionList" class="song-selection-list modal-scrollable"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- End of Add Songs tab content -->
                </div>
                <!-- Submit button now outside tab content -->
                <div class="setlist-submit-container">
                    <button type="submit" class="btn btn-primary" id="mySetlistSubmit" title="Create Personal Setlist - Save new private setlist" aria-label="Create My Setlist">Create Setlist</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Setlist View Modal -->
    <div class="modal" id="setlistViewModal">
        <div class="modal-content setlist-view-content">
            <span class="close-modal" aria-label="Close" title="Close Setlist View Modal">×</span>
            <div class="setlist-view-header">
                <h3 id="setlistViewTitle">Setlist</h3>
                <div class="setlist-view-actions">
                    <button id="editSetlistBtn" class="btn btn-secondary" title="Edit Setlist - Modify setlist details and song selection" aria-label="Edit Setlist">Edit</button>
                    <button id="deleteSetlistBtn" class="btn btn-danger" title="Delete Setlist - Permanently remove this setlist" aria-label="Delete Setlist">Delete</button>
                </div>
            </div>
            <p id="setlistViewDescription"></p>
            <div class="setlist-tabs">
                <div class="setlist-tab active" id="setlistNewTab" title="New Songs in Setlist - View contemporary songs" aria-label="New Songs Tab">New</div>
                <div class="setlist-tab" id="setlistOldTab" title="Old Songs in Setlist - View classic songs" aria-label="Old Songs Tab">Old</div>
            </div>
            <div class="setlist-songs-content">
                <div id="setlistNewSongs" class="setlist-songs-view"></div>
                <div id="setlistOldSongs" class="setlist-songs-view" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Setlist Modal -->
    <div class="modal" id="confirmDeleteSetlistModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Delete Setlist Confirmation Modal">×</span>
            <h3>Confirm Delete Setlist</h3>
            <div class="delete-setlist-form">
                <p id="deleteSetlistMessage">Are you sure you want to delete this setlist?</p>
                <div class="modal-actions">
                    <button id="cancelDeleteSetlist" class="btn btn-secondary" title="Cancel Deletion - Keep the setlist" aria-label="Cancel Delete">Cancel</button>
                    <button id="confirmDeleteSetlist" class="btn btn-danger" title="Confirm Deletion - Permanently remove this setlist" aria-label="Confirm Delete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Manual Song to Setlist Modal -->
    <div class="modal" id="addManualSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close" title="Close Add Manual Song Modal">×</span>
            <h3>Add Song to Setlist</h3>
            <form id="manualSongForm" class="manual-song-form">
                <div class="manual-song-section">
                    <label for="manualSongTitle">Song Title:</label>
                    <input type="text" id="manualSongTitle" required placeholder="Enter song title...">
                    <div id="existingSongsResults" class="existing-songs-results" style="display: none;">
                        <div class="existing-songs-header">Existing Songs Found:</div>
                        <div id="existingSongsList" class="existing-songs-list"></div>
                    </div>
                </div>
                
                <div class="manual-song-details">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualSongKey">Key:</label>
                            <select id="manualSongKey" required>
                                <option value="">Select Key</option>
                                <option value="C">C</option>
                                <option value="C#">C#</option>
                                <option value="D">D</option>
                                <option value="D#">D#</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F#">F#</option>
                                <option value="G">G</option>
                                <option value="G#">G#</option>
                                <option value="A">A</option>
                                <option value="A#">A#</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="manualSongTime">Time Signature:</label>
                            <select id="manualSongTime" required>
                                <option value="">Select Time</option>
                                <option value="4/4">4/4</option>
                                <option value="3/4">3/4</option>
                                <option value="2/4">2/4</option>
                                <option value="6/8">6/8</option>
                                <option value="12/8">12/8</option>
                                <option value="7/8">7/8</option>
                                <option value="5/4">5/4</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualSongTempo">Tempo (BPM):</label>
                            <input type="text" id="manualSongTempo" placeholder="e.g., 120 BPM">
                        </div>
                        
                        <div class="form-group">
                            <label for="manualSongCategory">Category:</label>
                            <select id="manualSongCategory" required>
                                <option value="New">New</option>
                                <option value="Old">Old</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelManualSong" title="Cancel - Close without adding song" aria-label="Cancel Add Song">Cancel</button>
                    <button type="submit" class="btn btn-primary" title="Add Song to Setlist - Create and add this song entry" aria-label="Add Song to Setlist">Add to Setlist</button>
                </div>
            </form>
        </div>
    </div>

    <script src="main.js"></script>
    <!-- Suggested Songs Drawer -->
<div class="suggested-songs-drawer" id="suggestedSongsDrawer">
    <div class="suggested-songs-header">
        <h3>Suggested Songs</h3>
        <button class="close-suggested-songs" id="closeSuggestedSongs" title="Close Recommendations - Hide suggested songs panel" aria-label="Close Suggested Songs">&times;</button>
    </div>
    <div id="suggestedSongsContent"></div>
</div>

<button class="toggle-suggested-songs" id="toggleSuggestedSongs" title="Recommended Songs - View AI-powered song recommendations based on current selection" aria-label="Toggle Suggested Songs">
    <i class="fa fa-random"></i>
</button>
</body>
<script>
window.addEventListener('DOMContentLoaded', async () => {
    try {
        // Show loading immediately on page load
        if (typeof showLoading === 'function') {
            showLoading(0);
        }
        await init();
    } catch (e) {
        console.error('App failed to initialize:', e);
        if (typeof hideLoading === 'function') {
            hideLoading();
        }
    }
});
</script>
</html>
