<!DOCTYPE html>
<html lang="en">
<head>

<script>
// Recommendation weights: loaded from backend or localStorage fallback
let WEIGHTS = JSON.parse(localStorage.getItem('recommendationWeights')) || {
    language: 20,
    scale: 30,
    timeSignature: 25,
    taal: 15,
    tempo: 5,
    genre: 5
};

async function fetchRecommendationWeights() {
    try {
        const res = await fetch(`${API_BASE_URL}/api/recommendation-weights`);
        if (res.ok) {
            const data = await res.json();
            WEIGHTS = data;
            localStorage.setItem('recommendationWeights', JSON.stringify(data));
        }
    } catch (e) { /* fallback to local */ }
}

async function saveRecommendationWeightsToBackend(weights) {
    try {
        const res = await fetch(`${API_BASE_URL}/api/recommendation-weights`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('jwtToken') || ''}`
            },
            body: JSON.stringify(weights)
        });
        if (res.ok) {
            const data = await res.json();
            localStorage.setItem('recommendationWeights', JSON.stringify(weights));
            WEIGHTS = weights;
            return { success: true, message: data.message || 'Weights updated' };
        } else {
            const err = await res.json();
            return { success: false, message: err.error || 'Failed to update weights' };
        }
    } catch (e) {
        return { success: false, message: 'Network error' };
    }
}
</script>
    <!-- Auth0 script removed: now using local JWT auth -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New & Old Songs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading spinner removed -->
    <div class="app-container">
        <button class="panel-toggle draggable" id="toggle-sidebar"><i class="fas fa-home"></i></button>
        <button class="panel-toggle draggable" id="toggle-songs"><i class="fas fa-list"></i></button>
        <button class="panel-toggle draggable" id="toggle-all-panels"><i class="fas fa-eye-slash"></i></button>

        <!-- Auto-scroll controls -->
        <div class="auto-scroll-controls">
            <button class="auto-scroll-btn" id="toggleAutoScroll" title="Auto Scroll"><i class="fas fa-play"></i></button>
        </div>

        <!-- Keep screen on button -->
        <button class="keep-screen-on" id="keepScreenOnBtn" title="Keep Screen On"><i class="fa fa-sign-language"></i></button>

        <!-- Notification -->
        <div class="notification" id="notification"></div>

        <!-- Sidebar -->
        <div class="sidebar hidden">
            <div class="sidebar-header">
                <h2>New & Old</h2>
            </div>
            <ul class="sidebar-menu">
                <div id="userGreeting" style="display:none;font-weight:bold;margin-bottom:8px;"></div>
                <button id="loginBtn" class="sidebar-btn btn-login"><i class="fas fa-sign-in-alt"></i> Login</button>
                <button id="logoutBtn" class="sidebar-btn btn-login" style="display:none;"><i class="fas fa-sign-out-alt"></i> Logout</button>
                <button id="adminPanelBtn" class="sidebar-btn" style="display:none;"><i class="fas fa-cogs"></i> Admin Panel</button>

            <div id="adminPanelModal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="document.getElementById('adminPanelModal').style.display='none'">&times;</span>
                    <h2>Admin Panel</h2>
                    <div class="admin-tabs">
                        <button class="admin-tab active" id="userMgmtTab">User Management</button>
                        <button class="admin-tab" id="weightsTab">Recommendation Weights</button>
                    </div>
                    <div class="admin-tab-content" id="userMgmtTabContent">
                        <div class="notification" id="adminNotification"></div>
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Admin</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="admin-tab-content" id="weightsTabContent" style="display:none;">
                        <div class="notification" id="weightsNotification"></div>
                        <form id="weightsForm" style="max-width: 420px; margin: 0 auto;">
                            <table id="weightsTable" style="width:100%; border-collapse:collapse; background:#fff; margin-bottom:16px;">
                            <div id="weightsTotalBar" style="margin: 10px 0 8px 0; text-align:center; font-weight:600; font-size:1.08em;"></div>
                                <thead>
                                    <tr style="background:#f6f8fa; color:#3498db; font-weight:600;">
                                        <th style="padding:10px 8px; text-align:left;">Parameter</th>
                                        <th style="padding:10px 8px; text-align:left;">Weight</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding:10px 8px;">Language</td>
                                           <td style="padding:10px 8px;"><input type="number" id="weightLanguage" min="0" max="100" step="5" required style="width:60px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px 8px;">Scale</td>
                                           <td style="padding:10px 8px;"><input type="number" id="weightScale" min="0" max="100" step="5" required style="width:60px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px 8px;">Time Signature</td>
                                           <td style="padding:10px 8px;"><input type="number" id="weightTimeSignature" min="0" max="100" step="5" required style="width:60px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px 8px;">Taal</td>
                                           <td style="padding:10px 8px;"><input type="number" id="weightTaal" min="0" max="100" step="5" required style="width:60px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px 8px;">Tempo</td>
                                           <td style="padding:10px 8px;"><input type="number" id="weightTempo" min="0" max="100" step="5" required style="width:60px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px 8px;">Genre</td>
                                           <td style="padding:10px 8px;"><input type="number" id="weightGenre" min="0" max="100" step="5" required style="width:60px;"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button type="submit" class="btn" style="width:100%;margin-top:8px;">Save Weights</button>
                        </form>
                        <div style="text-align:center; color:#888; font-size:0.98em; margin-top:4px;">Total should be 100 for best results.</div>
                    </div>
                </div>
            </div>
                <li><a href="#" class="active" id="showAll">All Songs</a></li>
                <li><a href="#" id="showSetlist">Setlist</a></li>   
                <li><a href="#" id="showFavorites">Favorites</a></li>
                <li><button id="addSongBelowFavoritesBtn" class="sidebar-btn" style="width:100%;margin-top:10px;"><i class="fa fa-plus"></i> Add New Song</button></li>

            </ul>
            </ul>
            <div class="sidebar-footer">
                <div class="sidebar-footer">
                    <div class="song-count">
                        <div>Total Songs: <span id="totalSongs">0</span></div>
                        <div>New: <span id="NewCount">0</span></div>
                        <div>Old: <span id="OldCount">0</span></div>
                    </div>

                    <div class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </div>

                    <button class="sidebar-btn" id="downloadHtmlWithSongsBtn">
                        <i class="fas fa-file-export"></i> Download HTML with Songs
                    </button>
                </div>
                <div class="sidebar-folder">
                    <div class="folder-toggle" id="toggleSongTools">
                        <i class="fas fa-folder-open"></i> Song Tools
                        <i class="fas fa-caret-down folder-caret"></i>
                    </div>
                    <div class="folder-content" id="songToolsContent">
                        <button class="sidebar-btn" id="openAddSongModal">
                            <i class="fa fa-plus"></i> Add New Song
                        </button>
                        <button class="sidebar-btn" id="downloadSongsBtn">
                            <i class="fas fa-download"></i> Download Songs
                        </button>
                        <button class="sidebar-btn btn-delete" id="deleteAllSongsBtn">
                            <i class="fas fa-trash-alt"></i> Delete All Songs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Songs Panel -->
        <div class="songs-section hidden">
            <div class="sticky-header">
                <div class="tabs">
                    <div class="setlist-tab active" id="NewTab">New</div>
                    <div class="setlist-tab" id="OldTab">Old</div>
                </div>
                <div class="filters-row">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="compact-input" placeholder="Search songs..."
                               style="padding-right: 30px;" autocomplete="off">
                        <span id="clearSearch" class="clear-search-btn" style="display: none;">×</span>
                        <div id="searchHistoryDropdown" class="search-history-dropdown"></div>
                    </div>
                    <select id="keyFilter" class="compact-select">
                        <option value="">All Keys</option>
                        <option value="C">C Major</option>
                        <option value="C#">C# Major</option>
                        <option value="D">D Major</option>
                        <option value="D#">D# Major</option>
                        <option value="E">E Major</option>
                        <option value="F">F Major</option>
                        <option value="F#">F# Major</option>
                        <option value="G">G Major</option>
                        <option value="G#">G# Major</option>
                        <option value="A">A Major</option>
                        <option value="A#">A# Major</option>
                        <option value="B">B Major</option>
                        <option value="Cm">Cm</option>
                        <option value="C#m">C#m</option>
                        <option value="Dm">Dm</option>
                        <option value="D#m">D#m</option>
                        <option value="Em">Em</option>
                        <option value="Fm">Fm</option>
                        <option value="F#m">F#m</option>
                        <option value="Gm">Gm</option>
                        <option value="G#m">G#m</option>
                        <option value="Am">Am</option>
                        <option value="A#m">A#m</option>
                        <option value="Bm">Bm</option>
                    </select>
                    <select id="genreFilter" class="compact-select">
                        <option value="">All Genres</option>
                        <option value="New">New</option>
                        <option value="Old">Old</option>
                        <option value="Romantic">Romantic</option>
                        <option value="Acoustic">Acoustic</option>
                        <option value="Blues">Blues</option>
                        <option value="Dance">Dance</option>
                        <option value="Love">Love</option>
                        <option value="Sad">Sad</option>
                        <option value="Patriotic">Patriotic</option>
                        <option value="Happy">Happy</option>
                        <option value="Qawalli">Qawalli</option>
                        <option value="Evergreen">Evergreen</option>
                        <option value="Classical">Classical</option>
                        <option value="Ghazal">Ghazal</option>
                        <option value="Sufi">Sufi</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Marathi">Marathi</option>
                        <option value="English">English</option>
                    </select>
                    <select id="sortFilter" class="compact-select" style="margin-top:6px;">
                        <option value="recent">Recently Added</option>
                        <option value="az">A-Z</option>
                        <option value="za">Z-A</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>

                <div class="search-results" id="searchResults">
                    <div class="search-results-header">Search Results</div>
                    <div id="searchResultsContent" class="scrollable-results"></div>
                </div>
            </div>
            <div class="tab-content active" id="NewContent"></div>
            <div class="tab-content" id="OldContent"></div>
            <div class="setlist" id="setlistSection" style="display: none;">
                <h3>Your Setlist</h3>
                <div class="setlist-tabs">
                    <div class="setlist-tab active" id="NewSetlistTab">New</div>
                    <div class="setlist-tab" id="OldSetlistTab">Old</div>
                </div>
                <div class="setlist-content">
                    <div id="NewSetlistSongs"></div>
                    <div id="OldSetlistSongs" style="display: none;"></div>
                </div>
            </div>
            <div class="delete-section" id="deleteSection" style="display: none;">
                <h3>Delete Songs</h3>
                <div id="deleteContent"></div>
            </div>
            <div class="favorites-section" id="favoritesSection" style="display: none;">
                <h3>Favorite Songs</h3>
                <div id="favoritesContent"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="songPreview">
            <h2>Select a song</h2>
            <div class="song-lyrics">No song is selected</div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Add New Song</h3>
            <form id="newSongForm" class="add-song-form">
                <label for="songTitle">Title:</label>
                <input type="text" id="songTitle" required>
                <label for="songCategory">Category:</label>
                <select id="songCategory" required>
                    <option value="New">New</option>
                    <option value="Old">Old</option>
                </select>
                <label for="songKey">Key:</label>
                <select id="songKey" required>
                    <option value="C">C</option>
                    <option value="C#">C#</option>
                    <option value="D">D</option>
                    <option value="D#">D#</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F#</option>
                    <option value="G">G</option>
                    <option value="G#">G#</option>
                    <option value="A">A</option>
                    <option value="A#">A#</option>
                    <option value="B">B</option>
                    <option value="Cm">Cm</option>
                    <option value="C#m">C#m</option>
                    <option value="Dm">Dm</option>
                    <option value="D#m">D#m</option>
                    <option value="Em">Em</option>
                    <option value="Fm">Fm</option>
                    <option value="F#m">F#m</option>
                    <option value="Gm">Gm</option>
                    <option value="G#m">G#m</option>
                    <option value="Am">Am</option>
                    <option value="A#m">A#m</option>
                    <option value="Bm">Bm</option>
                </select>
                <label for="songTempo">Tempo (BPM):</label>
                <input type="text" id="songTempo" placeholder="e.g., 80 BPM" >
                <label for="songTime">Time Signature:</label>
                <select id="songTime" >
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="2/4">2/4</option>
                    <option value="6/8">6/8</option>
                    <option value="5/4">5/4</option>
                    <option value="7/8">7/8</option>
                </select>
                <label for="songTaal">Taal:</label>
                <select id="songTaal" required>
                    <option value="Keherwa">Keherwa</option>
                    <option value="Keherwa Slow">Keherwa Slow</option>
                    <option value="Dadra">Dadra</option>
                    <option value="Dadra Slow">Dadra Slow</option>
                    <option value="Rupak">Rupak</option>
                    <option value="EkTaal">EkTaal</option>
                    <option value="JhapTaal">JhapTaal</option>
                    <option value="TeenTaal">TeenTaal</option>
                    <option value="Deepchandi">Deepchandi</option>
                    <option value="Garba">Garba</option>
                    <option value="Western">Western</option>
                    <option value="Waltz">Waltz</option>
                </select>
                <label for="songGenre">Genre:</label>
                <div class="multiselect-container">
                    <input type="text" id="songGenre" class="compact-input" placeholder="Select genres..." readonly>
                    <div class="multiselect-dropdown" id="genreDropdown">
                        <!-- Genre options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="selectedGenres"></div>
                </div>
                <label for="songLyrics">Lyrics:</label>
                <textarea id="songLyrics" required></textarea>
                <button type="submit" class="btn btn-primary">Add Song</button>
            </form>
        </div>
    </div>

    <div class="modal" id="editSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Edit Song</h3>
            <form id="editSongForm" class="edit-song-form">
                <input type="hidden" id="editSongId">
                <label for="editSongTitle">Title:</label>
                <input type="text" id="editSongTitle" required>
                <label for="editSongCategory">Category:</label>
                <select id="editSongCategory" required>
                    <option value="New">New</option>
                    <option value="Old">Old</option>
                </select>
                <label for="editSongKey">Key:</label>
                <select id="editSongKey" required>
                    <option value="C">C Major</option>
                    <option value="C#">C# Major</option>
                    <option value="D">D Major</option>
                    <option value="D#">D# Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="F#">F# Major</option>
                    <option value="G">G Major</option>
                    <option value="G#">G# Major</option>
                    <option value="A">A Major</option>
                    <option value="A#">A# Major</option>
                    <option value="B">B Major</option>
                    <option value="Cm">Cm</option>
                    <option value="C#m">C#m</option>
                    <option value="Dm">Dm</option>
                    <option value="D#m">D#m</option>
                    <option value="Em">Em</option>
                    <option value="Fm">Fm</option>
                    <option value="F#m">F#m</option>
                    <option value="Gm">Gm</option>
                    <option value="G#m">G#m</option>
                    <option value="Am">Am</option>
                    <option value="A#m">A#m</option>
                    <option value="Bm">Bm</option>
                </select>
                <label for="editSongTempo">Tempo (BPM):</label>
                <input type="text" id="editSongTempo" placeholder="e.g., 80 BPM">
                <label for="editSongTime">Time Signature:</label>
                <select id="editSongTime" required>
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="2/4">2/4</option>
                    <option value="6/8">6/8</option>
                    <option value="5/4">5/4</option>
                    <option value="7/8">7/8</option>
                </select>
                <label for="editSongTaal">Taal:</label>
                <select id="editSongTaal" required>
                    <option value="Keherwa">Keherwa</option>
                    <option value="Keherwa Slow">Keherwa Slow</option>
                    <option value="Dadra">Dadra</option>
                    <option value="Dadra Slow">Dadra Slow</option>
                    <option value="Rupak">Rupak</option>
                    <option value="EkTaal">EkTaal</option>
                    <option value="JhapTaal">JhapTaal</option>
                    <option value="TeenTaal">TeenTaal</option>
                    <option value="Deepchandi">Deepchandi</option>
                    <option value="Garba">Garba</option>
                    <option value="Western">Western</option>
                    <option value="Waltz">Waltz</option>
                </select>
                <label for="editSongGenre">Genre:</label>
                <div class="multiselect-container">
                    <input type="text" id="editSongGenre" class="compact-input" placeholder="Select genres..." readonly>
                    <div class="multiselect-dropdown" id="editGenreDropdown">
                        <!-- Genre options will be rendered dynamically by JS -->
                    </div>
                    <div class="multiselect-selected" id="editSelectedGenres"></div>
                </div>
                <label for="editSongLyrics">Lyrics:</label>
                <textarea id="editSongLyrics" required></textarea>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="deleteSongModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Confirm Deletion</h3>
            <form id="deleteSongForm" class="delete-song-form">
                <input type="hidden" id="deleteSongId">
                <p id="deleteSongMessage">Are you sure you want to delete "<span id="deleteSongTitle"></span>"?</p>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-cancel" id="cancelDeleteSong">Cancel</button>
                    <button type="submit" class="btn btn-delete">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="confirmDeleteAllModal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close">×</span>
            <h3>Confirm Delete All Songs</h3>
            <div class="delete-song-form">
                <p>Are you sure you want to delete ALL songs? This cannot be undone.</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-cancel" id="cancelDeleteAll">Cancel</button>
                    <button class="btn btn-delete" id="confirmDeleteAll">Delete All</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('settingsModal').style.display='none'">×</span>
            <h3>Settings</h3>
            <form id="settingsForm">
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="sidebarHeaderInput">Sidebar Header:</label>
                        <input type="text" id="sidebarHeaderInput" required>
                    </div>
                    <div class="settings-group">
                        <label for="setlistTextInput">Setlist Menu Text:</label>
                        <input type="text" id="setlistTextInput" required>
                    </div>
                    <div class="settings-group">
                        <label for="sessionResetOption">Session Reset:</label>
                        <select id="sessionResetOption">
                            <option value="manual">Manual (default)</option>
                            <option value="onClose">Reset on window close</option>
                            <option value="onRefresh">Reset on page refresh</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <label for="sidebarWidthInput">Sidebar Width (%):</label>
                        <input type="number" id="sidebarWidthInput" min="10" max="100" value="20">
                    </div>
                    <div class="settings-group">
                        <label for="songsPanelWidthInput">Songs Panel Width (%):</label>
                        <input type="number" id="songsPanelWidthInput" min="10" max="100" value="20">
                    </div>
                    <div class="settings-group">
                        <label for="previewMarginInput">Preview Margin Left (px):</label>
                        <input type="number" id="previewMarginInput" min="0" max="100" value="5">
                    </div>
                    <div class="settings-group">
                        <label for="autoScrollSpeedInput">Auto Scroll Speed:</label>
                        <select id="autoScrollSpeedInput">
                            <option value="2000">Slow</option>
                            <option value="1500" selected>Medium</option>
                            <option value="1000">Fast</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>
    <script src="main.js"></script>
    <!-- Suggested Songs Drawer -->
<div class="suggested-songs-drawer" id="suggestedSongsDrawer">
    <div class="suggested-songs-header">
        <h3>Suggested Songs</h3>
        <button class="close-suggested-songs" id="closeSuggestedSongs">&times;</button>
    </div>
    <div id="suggestedSongsContent"></div>
</div>

<button class="toggle-suggested-songs" id="toggleSuggestedSongs" title="Suggested Songs">
    <i class="fa fa-random"></i>
</button>
</body>
<script>
window.addEventListener('DOMContentLoaded', async () => {
    try {
        await init();
    } catch (e) {
        console.error('App failed to initialize:', e);
    }
});
</script>
</html>
